# HTTP 1.1 新特性

本节介绍三个HTTP 1.1的新特性，理解了它们，就能更好地理解默认连接器是怎么处理HTTP请求的。

## 持久连接

在HTTP 1.1之前，服务器在发送完响应之后就会断开连接，但是一个页面往往还会包含一些其他资源，如图片、Applets等。当请求一个页面时，浏览器还需要下载这个页面引用的资源。如果使用不同的连接来下载这个页面和它所引用的资源，就会非常慢。因此，HTTP 1.1中引入了持久连接。使用持久连接，当一个页面下载完后，服务器不会立即断开连接，它会继续等待客户端请求这个页面所引用的资源，即可以使用同一个连接来下载页面和它引用的资源。对于服务器、客户端和网络来说，这都将会节省大量的工作和时间，毕竟建立和断开连接是很昂贵的。

在HTTP 1.1中，默认使用持久连接，当然也可以显示地声明，在请求头中加入下面的参数：

```
connection: keep-alive
```

## 分块编码

建立持久连接的结果是服务器可以从多个资源文件发送字节流，客户端也能够通过同一个连接发送多个请求，因此，对于每个请求和响应，发送方都必须在headers中带上content length，这样接收方才能够知道该怎样解释这些字节。然而，发送方往往也并不知道它会发送多少字节，例如，servlet容器可能在接收到一些字节之后就开始发送响应，而不必等待这些字节全部接收完。这意味着，必须要有一种方法能够告诉接收方，在不知道发送内容长度的情况下该如何解释接收到的字节。

即使没有发送多个请求或者响应，服务器或者客户端也没有必要知道它会发送多少数据。在HTTP 1.0，服务器可以省略content-length，只管往连接中写数据，当它写完后，只需要简单地关闭连接即可，客户端就会一直读取直到返回-1，表示已经读完了。

HTTP 1.1使用一个叫做transfer-encoding的header来表示字节流将会分块发送。对于每一个块，块的长度（十六进制表示）后面接CR/LF，再接数据。一个事务用一个长度为0的块标记。举个栗子，你想用2个块来发送下面的38个字节的数据，第一个块的长度为29，第二个为9

```
I'm as helpless as a kitten up a tree. 
```

那么发送的块应该是这样的：

```
1D\r\n
I'm as helpless as a kitten u
9\r\n
p a tree.
0\r\n
```

"1D"十进制表示29，表示第一个包含29个字节，0\r\n表示这个事务结束。

## 状态码100的使用

HTTP1.1客户端在发送请求体之前可能会先发送带有Expect: 100-continue头信息的请求，然后等待服务器的确认，这种情况通常发生在客户端准备发送一个很长的请求体、不知道服务器会不会接收的情况下。如果客户端发送了一个很长的请求体但是后面发现服务器不接收，这是很浪费的。

当接收到Expect: 100-continue这个头信息，如果服务器会处理或者能处理这个请求，将在响应中添加如下的头信息（有两个CRLF）：

```
HTTP/1.1 100 Continue 
```

然后，服务器会继续读取输入流。